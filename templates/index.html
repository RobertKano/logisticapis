<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¢–ö | API Data Service</title>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <style>
        :root {
            --brand-blue: #0a2351;
            --accent-blue: #1a4a9e;
            --bg-light: #f8fafc;
            --success-green: #22c55e;
            --card-shadow: 0 4px 12px rgba(10, 35, 81, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            background-color: var(--bg-light);
            color: #1e293b;
        }

        .status-indicator {
            display: inline-block; width: 10px; height: 10px;
            background-color: var(--success-green); border-radius: 50%;
            margin-right: 8px; position: relative;
        }
        .status-indicator.loading { background-color: var(--accent-blue); }
        .status-pulse {
            position: absolute; width: 100%; height: 100%;
            background-color: var(--success-green); border-radius: 50%;
            animation: pulse 2s infinite; opacity: 0.6;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(3); opacity: 0; } }

        .container-fluid { max-width: 1600px; padding: 2rem; }

        .stat-card {
            background: white; border-radius: 12px; padding: 1.25rem;
            border: 1px solid #e2e8f0; box-shadow: var(--card-shadow);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: #64748b; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 5px; }

        .table-container {
            background: white; border-radius: 12px;
            box-shadow: var(--card-shadow); overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table thead th {
            background-color: var(--brand-blue); color: white;
            font-weight: 500; text-transform: uppercase;
            font-size: 0.7rem; padding: 15px; border: none;
        }

        .row-arrived { background-color: #f0fdf4 !important; border-left: 4px solid var(--success-green); }
        .table-hover tbody tr:hover { background-color: #f1f5f9; }

        .btn-brand { background-color: var(--brand-blue); color: white; border-radius: 8px; font-weight: 500; }
        .btn-brand:hover { background-color: var(--accent-blue); color: white; }

        .copy-btn {
            opacity: 0;
            cursor: pointer;
            margin-left: 8px;
            transition: opacity 0.2s;
            color: var(--accent-blue);
        }
        tr:hover .copy-btn {
            opacity: 1;
        }
        .copy-btn:hover {
            color: #000;
            transform: scale(1.2);
        }
        code { color: var(--accent-blue); background: #f0f7ff; padding: 3px 6px; border-radius: 4px; }
        .badge-tk { font-weight: 500; padding: 5px 10px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            .table thead { display: none; }
            .table tbody tr { display: block; margin: 15px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; }
            .table tbody td { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; }
            .table tbody td::before { content: attr(data-label); font-weight: 600; color: #64748b; }
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <div class="d-flex align-items-center">
                    <div class="status-indicator" id="api-status"><div class="status-pulse"></div></div>
                    <h4 class="m-0 fw-bold">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</h4>
                </div>
                <small class="text-muted">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <span id="update-time">‚Äî</span></small>
            </div>
            <button onclick="loadReportData()" class="btn btn-sm btn-brand px-4 shadow-sm" id="refresh-btn">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    <div class="stat-value text-dark" id="stat-total">0</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card" style="border-top: 4px solid var(--success-green);">
                    <div class="stat-label">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–±–æ—Ä—É</div>
                    <div class="stat-value text-success" id="stat-ready">0</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card" style="border-top: 4px solid var(--accent-blue);">
                    <div class="stat-label">–í –ø—É—Ç–∏</div>
                    <div class="stat-value text-primary" id="stat-transit">0</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card" style="border-top: 4px solid #ef4444;">
                    <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</div>
                    <div class="stat-value text-danger" id="stat-debt">0</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4 align-items-center">
            <div class="col-md-6">
                <div class="position-relative">
                    <input type="text" id="searchInput" class="form-control border-0 shadow-sm"
                           style="border-radius: 10px; padding: 12px 45px 12px 20px;"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π, –¢–ö –∏–ª–∏ –≥–æ—Ä–æ–¥—É...">

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <span id="clearSearch" class="position-absolute"
                          style="right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; display: none; font-size: 1.2rem;">
                        &times;
                    </span>
                </div>
            </div>
            <div class="col-md-3">
                <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã -->
                <input type="date" id="dateFilter" class="form-control border-0 shadow-sm" style="border-radius: 10px; padding: 10px 15px;">
            </div>
            <div class="col-md-3 text-md-end">
                <div class="btn-group shadow-sm bg-white p-1" style="border-radius: 10px;">
                    <button class="btn btn-light active" id="btn-active" onclick="setView('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                    <button class="btn btn-light" id="btn-archive" onclick="setView('archive')">–ê—Ä—Ö–∏–≤</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>–¢–ö</th>
                        <th>‚Ññ –ù–∞–∫–ª–∞–¥–Ω–æ–π</th>
                        <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                        <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                        <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                        <th>–ì—Ä—É–∑</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th onclick="toggleSort()" style="cursor: pointer; user-select: none;">
                            –ü—Ä–∏–±—ã—Ç–∏–µ <span id="sort-icon">üîΩ</span>
                        </th>
                        <th>–û–ø–ª–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody id="report-table-body"></tbody>
            </table>
        </div>
    </div>


    <footer class="container-fluid mt-5 mb-4">
        <div class="row border-top pt-4 align-items-center">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–æ–ø–∏—Ä–∞–π—Ç -->
            <div class="col-md-6 text-muted small">
                ¬© 2024-2026 <strong>LogisticAPIs Service</strong><br>
                –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ v1.0 (MVP)
            </div>

            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –∏ —Ç–µ–∫—Å—Ç–æ–º, –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–π –≤ –ª–∏–Ω–∏—é —Å–ø—Ä–∞–≤–∞ -->
            <div class="col-md-6 text-md-right text-center mt-3 mt-md-0">

                <div class="d-flex align-items-center justify-content-center justify-content-md-end">

                    <!-- –ù–û–í–ê–Ø –°–°–´–õ–ö–ê –ù–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Æ -->
                    <a href="/docs/" class="text-muted small mr-3" target="_blank" style="text-decoration: underline; opacity: 0.8;">
                        **API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
                    </a>
                    <!-- –ö–û–ù–ï–¶ –ù–û–í–û–ô –°–°–´–õ–ö–ò -->

                    <!-- 1 —ç–ª–µ–º–µ–Ω—Ç: "–°–µ—Ä–≤–∏—Å —Å—ç–∫–æ–Ω–æ–º–∏–ª –≤—Ä–µ–º—è?" -->
                    <span class="text-muted small mr-2">–°–µ—Ä–≤–∏—Å —Å—ç–∫–æ–Ω–æ–º–∏–ª –≤—Ä–µ–º—è?</span>

                    <!-- 2 —ç–ª–µ–º–µ–Ω—Ç: –ù–∞—à–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (—Å—Å—ã–ª–∫–∞) -->
                    <a href="https://yoomoney.ru/to/4100119466723517"
                       target="_blank"
                       class="btn btn-sm text-white mr-2"
                       style="background-color: #725dff; border-radius: 8px; font-weight: 500;">
                        –ü–æ–¥–∞—Ä–∏—Ç—å
                    </a>

                    <!-- 3 —ç–ª–µ–º–µ–Ω—Ç: "–ß–∞—à–∫—É –∫–æ—Ñ–µ" -->
                    <span class="text-muted small">
                        <strong>–ß–∞—à–∫—É –∫–æ—Ñ–µ</strong>
                    </span>

                </div>
            </div>
        </div>

        <!-- –ü–æ–¥–ø–∏—Å—å –∞–≤—Ç–æ—Ä–∞ -->
        <div class="text-center mt-4">
            <small class="text-muted" style="font-size: 0.7rem; opacity: 0.6;">
                Developed with ‚ù§Ô∏è by RobertKano
            </small>
        </div>
    </footer>

    <script>
        let currentView = 'active';
        let fullData = { active: [], archive: [] };
        let sortDirection = 'desc'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É

        function toggleSort(column) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            const icon = document.getElementById('sort-icon');
            icon.innerHTML = sortDirection === 'asc' ? 'üîº' : 'üîΩ';

            renderTable();
        }

        function setView(view) {
            currentView = view;
            document.getElementById('btn-active').classList.toggle('active', view === 'active');
            document.getElementById('btn-archive').classList.toggle('active', view === 'archive');
            renderTable();
        }

        function copyToClipboard(id, btn) {
            const list = fullData[currentView] || [];
            const item = list.find(r => String(r.id) === String(id));
            if (!item) return;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–µ—Ç–∫—É –æ–ø–ª–∞—Ç—ã –¥–ª—è –±—É—Ñ–µ—Ä–∞
            const pRaw = (item.payment || "").toLowerCase();
            const isPaid = pRaw.startsWith('–æ–ø–ª–∞—á–µ') && !pRaw.includes('–∫ ');
            const paymentStatus = isPaid ? "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ" : `‚ö†Ô∏è ${item.payment.toUpperCase()}`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω:
            // –¢–ö (–ú–∞—Ä—à—Ä—É—Ç)
            // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–ù–æ–º–µ—Ä)
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
            // –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
            const text = `${item.tk} (${item.route})\n${item.sender} (${item.id})\n${item.params}\n${paymentStatus}`;

            navigator.clipboard.writeText(text).then(() => {
                const oldInner = btn.innerHTML;
                btn.innerHTML = '‚úÖ';
                setTimeout(() => { btn.innerHTML = oldInner; }, 1500);
            });
        }




        function renderTable() {
            const tbody = document.getElementById('report-table-body');
            // 1. –ë–µ—Ä–µ–º –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            let list = [...(fullData[currentView] || [])];
            tbody.innerHTML = '';

            // 2. –î–û–ë–ê–í–õ–Ø–ï–ú –°–û–†–¢–ò–†–û–í–ö–£ –ó–î–ï–°–¨
            list.sort((a, b) => {
                // –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å arrival, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–¥–ª—è –∞—Ä—Ö–∏–≤–∞) ‚Äî –ø—Ä–æ–±—É–µ–º archived_at
                const dateA = new Date(a.arrival || (a.archived_at ? a.archived_at.split('.').reverse().join('-') : 0));
                const dateB = new Date(b.arrival || (b.archived_at ? b.archived_at.split('.').reverse().join('-') : 0));

                return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            });

            // —Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –≤–æ —Ñ—Ä–æ–Ω—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ –±—ç–∫–∞
            list.forEach(r => {
                const rawStatus = (r.status || '').toLowerCase();
                let displayStatus = r.status;
                let statusClass = "text-dark";

                if (rawStatus.includes('–ø—Ä–∏–±—ã–ª') || rawStatus.includes('–≥–æ—Ç–æ–≤') || rawStatus.includes('—Ö—Ä–∞–Ω–µ–Ω–∏–µ')) {
                    displayStatus = "‚úÖ –ü—Ä–∏–±—ã–ª –≤ –¢–ö";
                    statusClass = "text-success";
                } else if (rawStatus.includes('–ø—É—Ç–∏') || rawStatus.includes('—Ç—Ä–∞–Ω–∑–∏—Ç') || rawStatus.includes('–ø—Ä–∏–Ω—è—Ç')){
                    displayStatus = "üöö –í –ø—É—Ç–∏";
                    statusClass = "text-primary";
                } else if (rawStatus.includes('–æ—Å—Ç–∞–≤–∫') || rawStatus.includes('–î–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–∞ –¥–æ –∞–¥—Ä–µ—Å–∞') || rawStatus.includes('–¥–æ –∞–¥—Ä–µ—Å–∞') || rawStatus.includes('–¥–æ –∞–¥—Ä–µ—Å–∞')){
                    displayStatus = "üöö –î–æ—Å—Ç–∞–≤–∫–∞ –¢–ö ‚û°Ô∏è –°–ö–õ–ê–î";
                    statusClass = "text-success";
                }

                // --- –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–ê –û–ü–õ–ê–¢–´ (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø –í–ï–†–°–ò–Ø) ---
                const pRaw = (r.payment || "").toLowerCase();

                // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï
                // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ "–æ–ø–ª–∞—á–µ" –ò –≤ —Å—Ç—Ä–æ–∫–µ –ù–ï–¢ —Å–ª–æ–≤–∞ "–∫ " (—á—Ç–æ–±—ã –æ—Ç—Å–µ—á—å "–ö –æ–ø–ª–∞—Ç–µ")
                const isActuallyPaid = pRaw.startsWith('–æ–ø–ª–∞—á–µ') && !pRaw.includes('–∫ ');

                // 2. –í–´–ë–ò–†–ê–ï–ú –°–¢–ò–õ–¨ –ò –¢–ï–ö–°–¢
                let pStyle = "";
                let pDisplay = r.payment;

                if (isActuallyPaid) {
                    pStyle = "text-success fw-bold";
                    pDisplay = "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ";
                } else {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥ –∏–ª–∏ "–∫ –æ–ø–ª–∞—Ç–µ" ‚Äî —Ä–∏—Å—É–µ–º –ö–†–ê–°–ù–£–Æ –ø–ª–∞—à–∫—É
                    pStyle = "badge bg-danger text-white px-2 py-1 shadow-sm";
                    pDisplay = "‚ö†Ô∏è " + r.payment;
                }
                // ------------------------------------------------

                let tkStyle = "background: #f1f5f9; color: #475569;";
                if(r.tk.includes('–ü–≠–ö')) tkStyle = "background: #fef9c3; color: #854d0e; border: 1px solid #fde047;";
                if(r.tk.includes('–î–µ–ª–æ–≤—ã–µ')) tkStyle = "background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe;";

                // –∏–∫–æ–Ω–∫–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤
                let payerIcon = '';
                let payerTitle = '';
                if (r.payer_type === 'recipient') {
                    payerIcon = '<span class="ms-1" title="–ü–ª–∞—Ç–∏—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—å">‚¨áÔ∏è</span>';
                } else if (r.payer_type === 'sender') {
                    payerIcon = '<span class="ms-1" title="–ü–ª–∞—Ç–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å">‚¨ÜÔ∏è</span>';
                } else {
                    payerIcon = '<span class="ms-1" title="–ü–ª–∞—Ç–∏—Ç —Ç—Ä–µ—Ç—å–µ –ª–∏—Ü–æ">üë§</span>';
                }

                const tr = document.createElement('tr');
                if (displayStatus.includes('—Å–∫–ª–∞–¥–µ') && currentView === 'active') tr.classList.add('row-arrived');

                const rawDate = r.arrival ? r.arrival.split('T')[0] :
               (r.archived_at ? r.archived_at.split('.').reverse().join('-') : '0000-00-00');


                tr.innerHTML = `
                    <td data-label="–¢–ö"><span class="badge-tk" style="${tkStyle}">${r.tk}</span></td>
                    <td data-label="‚Ññ –ù–∞–∫–ª–∞–¥–Ω–æ–π">
                        <code>${r.id}</code> ${payerIcon}
                        <span class="copy-btn" onclick="copyToClipboard('${r.id}', this)" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ">üìã</span>
                    </td>
                    <td data-label="–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å">${r.sender}</td>
                    <td data-label="–ü–æ–ª—É—á–∞—Ç–µ–ª—å">${r.recipient || '‚Äî'}</td>
                    <td data-label="–ú–∞—Ä—à—Ä—É—Ç">${r.route}</td>
                    <td data-label="–ì—Ä—É–∑"><small class="">${r.params}</small></td>
                    <td data-label="–°—Ç–∞—Ç—É—Å" class="fw-bold ${statusClass}">${displayStatus}</td>
                    <td data-label="–ü—Ä–∏–±—ã—Ç–∏–µ" data-date="${rawDate}">
                        <strong>${r.arrival ? r.arrival.split('T')[0] : (r.archived_at || '‚Äî')}</strong>
                    </td>
                    <td data-label="–û–ø–ª–∞—Ç–∞"><span class="${pStyle}">${pDisplay}</span></td>
                `;
                tbody.appendChild(tr);
            });
            filterTable();
        }

        function loadReportData() {
            const btn = document.getElementById('refresh-btn');
            const statusInd = document.getElementById('api-status');
            btn.disabled = true; statusInd.classList.add('loading');

            fetch('/api/latest')
                .then(r => r.json())
                .then(data => {
                    fullData = data;
                    document.getElementById('update-time').textContent = data.metadata.created_at;
                    document.getElementById('stat-total').textContent = data.active.length;
                    document.getElementById('stat-ready').textContent = data.active.filter(r =>
                        ["–ø—Ä–∏–±—ã–ª", "–≥–æ—Ç–æ–≤", "—Ö—Ä–∞–Ω–µ–Ω–∏–µ"].some(w => r.status.toLowerCase().includes(w))
                    ).length;
                    // document.getElementById('stat-transit').textContent = data.active.filter(r =>
                    //     r.status.toLowerCase().includes('–ø—É—Ç–∏')
                    // ).length;
                    document.getElementById('stat-transit').textContent = data.active.filter(r => {
                        const status = r.status.toLowerCase();
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ —ç—Ç–∏—Ö —Ñ—Ä–∞–∑
                        return ['–ø—É—Ç–∏', '–ø—Ä–∏–Ω—è—Ç –∫ –ø–µ—Ä–µ–≤–æ–∑–∫–µ', '–≤ –¥–æ—Ä–æ–≥–µ'].some(word => status.includes(word));
                    }).length;
                    document.getElementById('stat-debt').textContent = data.active.filter(r => {
                        const paymentLower = r.payment.toLowerCase();
                        const isPaid = paymentLower.startsWith('–æ–ø–ª–∞—á–µ') || !paymentLower.includes('–Ω–µ');
                        return !isPaid; // –°—á–∏—Ç–∞–µ–º —Ç–µ, —á—Ç–æ –ù–ï –æ–ø–ª–∞—á–µ–Ω—ã
                    }).length;
                    renderTable();
                })
                .finally(() => {
                    btn.disabled = false; statusInd.classList.remove('loading');
                });
        }


        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearch');

        // –°–ª–µ–¥–∏–º –∑–∞ –≤–≤–æ–¥–æ–º —Ç–µ–∫—Å—Ç–∞
        searchInput.addEventListener('input', function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫, –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ
            clearBtn.style.display = this.value.length > 0 ? 'block' : 'none';
            filterTable(); // –¢–≤–æ—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        });

        // –õ–æ–≥–∏–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            this.style.display = 'none';   // –ü—Ä—è—á–µ–º –∫—Ä–µ—Å—Ç–∏–∫
            searchInput.focus();           // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ
            filterTable();                 // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
        });

        function filterTable() {
            const textFilter = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value; // –§–æ—Ä–º–∞—Ç –ì–ì–ì–ì-–ú–ú-–î–î –∏–∑ –∏–Ω–ø—É—Ç–∞

            document.querySelectorAll('#report-table-body tr').forEach(row => {
                const text = row.textContent.toLowerCase();

                // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¥–æ—Å—Ç–∞–µ–º –¥–∞—Ç—É –∏–∑ –¥–∞—Ç–∞-–∞—Ç—Ä–∏–±—É—Ç–∞, –∞ –Ω–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É [6]
                const dateCell = row.querySelector('[data-date]');
                const rowDate = dateCell ? dateCell.getAttribute('data-date') : '';

                let matchesText = text.includes(textFilter);
                let matchesDate = true;

                if (dateFilter) {
                    // –ü—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –ì–ì–ì–ì-–ú–ú-–î–î === –ì–ì–ì–ì-–ú–ú-–î–î
                    matchesDate = (rowDate === dateFilter);
                }

                row.style.display = (matchesText && matchesDate) ? '' : 'none';
            });
        }


        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–æ–∂–µ
        document.getElementById('dateFilter').addEventListener('change', filterTable);

        document.getElementById('searchInput').addEventListener('keyup', filterTable);
        loadReportData();
        setInterval(loadReportData, 60000);
    </script>
</body>

</html>
